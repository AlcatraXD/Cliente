<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Manicure - Clientes & Servi√ßos</title>

<!-- Meta tags otimizadas para PWA/APK -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#d81b60">
<meta name="description" content="Aplicativo para gest√£o de clientes e servi√ßos de manicure">
<meta name="keywords" content="manicure, beleza, clientes, servi√ßos, agenda">

<!-- Manifest para PWA -->
<link rel="manifest" href="manifest.json">

<!-- √çcone para AppsGeyser -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíÖ</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíÖ</text></svg>">

<style>
  :root{
    --rose:#d81b60; --rose-dark:#ad1457; --ok:#2e7d32; --bad:#c62828;
    --bg:#f0f2f5; --card:#fff; --text:#333; --muted:#666; --shadow:0 2px 8px rgba(0,0,0,.09);
    --safe-area-inset-top: env(safe-area-inset-top);
    --safe-area-inset-bottom: env(safe-area-inset-bottom);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html{scroll-behavior:smooth; height: 100%;}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    min-height: 100vh;
    min-height: -webkit-fill-available;
  }
  ::-webkit-scrollbar { display: none; }

  /* Tela de Carregamento (Splash Screen) */
  #loader {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg); display: flex;
    align-items: center; justify-content: center;
    transition: opacity 0.3s ease;
  }
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid #ddd;
    border-top-color: var(--rose);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  header{
    background:var(--rose);color:#fff;text-align:center;padding:14px 12px;font-weight:700;
    box-shadow:var(--shadow); position: relative; padding-top: max(14px, env(safe-area-inset-top));
  }
  .menu-toggle {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    margin: 0;
    width: auto;
  }
  nav{
    position:sticky;top:0;background:#fff;z-index:50;display:flex;box-shadow:var(--shadow);
    padding-bottom: env(safe-area-inset-top);
  }
  nav button{
    flex:1;background:transparent;border:none;padding:12px;font-weight:600;cursor:pointer;
    color:var(--muted);transition:all .2s ease; font-size: 0.9rem;
    touch-action: manipulation;
  }
  nav button.active{color:var(--rose);border-bottom:3px solid var(--rose)}
  main{padding:12px;max-width:620px;margin:0 auto; padding-bottom: calc(12px + env(safe-area-inset-bottom));}
  h2{margin:16px 0 8px;color:var(--rose);font-size:1.05rem}
  input,button,select,textarea{
    width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:1rem;margin:4px 0;
    font-family: inherit;
  }
  input:focus, select:focus, textarea:focus{outline:none;border-color:var(--rose);box-shadow:0 0 0 2px #d81b6022}
  button{
    background:var(--rose);color:#fff;border:none;cursor:pointer;font-weight:600;
    transition:all .2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    touch-action: manipulation;
    min-height: 44px;
  }
  button:hover{background:var(--rose-dark)}
  button.clean{background:var(--card);color:var(--rose);border:1px solid var(--rose)}
  button.clean:hover{background:#fdecf4}
  button:active{transform: scale(0.98); opacity: 0.9;}
  button:disabled { opacity: 0.6; cursor: not-allowed; }
  button svg { width: 1em; height: 1em; }

  section{display:none} section.active{display:block}
  .row{display:flex;gap:8px;flex-wrap:wrap} .row>*{flex:1 1 140px}
  .list{display:flex;flex-direction:column;gap:10px}
  .card{
    background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:12px;
    transition: transform 0.2s;
  }
  .card:active {
    transform: scale(0.98);
  }
  .client{display:flex;flex-direction:column;gap:6px}
  .client .name{font-weight:700} .client .meta{color:var(--muted);font-size:.95rem}
  .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .actions button{flex:1; min-width: 90px; flex-basis: 120px; padding: 11px;}

  .service-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; }
  .service-item .info { flex-grow: 1; }
  .service-item .actions { margin-top: 0; flex-shrink: 0; }

  .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .tile{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:12px;text-align:center}
  .tile h3{margin:0 0 6px;color:var(--muted);font-size:.9rem;font-weight:600}
  .tile p{margin:0;font-size:1.2rem;font-weight:800;color:var(--rose)}
  .empty{padding:16px;text-align:center;color:var(--muted);background:var(--card);border-radius:12px;}
  .ok{background:var(--ok)!important} .danger{background:var(--bad)!important}

  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:flex-end;
    justify-content:center;padding:10px;z-index:100;opacity:0;visibility:hidden;transition:opacity .2s, visibility .2s;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
  }
  .modal.show{opacity:1;visibility:visible}
  .modal-content{
    background:#fff;width:100%;max-width:520px;border-radius:16px 16px 12px 12px;
    box-shadow:0 -5px 30px rgba(0,0,0,.2);padding:14px;max-height:86vh;overflow:auto;
    transform:translateY(20px);transition:transform .25s ease-out;
  }
  .modal.show .modal-content{transform:translateY(0)}
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal-head h3{margin:0;color:#444}
  .modal-close{
    background:transparent;border:none;font-size:1.6rem;color:var(--rose);line-height:1;
    padding:4px 8px;cursor:pointer; min-height: auto; width: auto;
  }
  .opt{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
  .opt:last-child{border-bottom:none}

  .toast{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);
    color:white;padding:10px 20px;border-radius:20px;z-index:200;font-size:0.9rem;
    opacity:0;visibility:hidden;transition:all .3s ease;
    bottom: calc(20px + env(safe-area-inset-bottom));
  }
  .toast.show{opacity:1;visibility:visible;bottom: calc(30px + env(safe-area-inset-bottom))}

  /* Menu lateral para mobile */
  .side-menu {
    position: fixed;
    top: 0;
    left: -280px;
    width: 280px;
    height: 100%;
    background: white;
    z-index: 150;
    box-shadow: 2px 0 10px rgba(0,0,0,0.2);
    transition: left 0.3s ease;
    padding: 20px;
    padding-top: max(20px, env(safe-area-inset-top));
    overflow-y: auto;
  }
  .side-menu.open {
    left: 0;
  }
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 140;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  .overlay.show {
    opacity: 1;
    visibility: visible;
  }
  .menu-item {
    display: block;
    padding: 15px 10px;
    border-bottom: 1px solid #eee;
    text-decoration: none;
    color: #333;
    font-weight: 500;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
  }
  .menu-header {
    padding: 15px 10px;
    font-weight: bold;
    color: var(--rose);
    border-bottom: 2px solid var(--rose);
    margin-bottom: 10px;
  }

  /* Melhorias para inputs em mobile */
  input[type="date"] {
    -webkit-appearance: none;
    min-height: 44px;
  }

  /* Ajustes para telas muito pequenas */
  @media (max-width: 360px) {
    .row > * {
      flex-basis: 100%;
    }
    .actions button {
      flex-basis: calc(50% - 3px);
    }
    nav button {
      font-size: 0.8rem;
      padding: 10px 8px;
    }
  }

  @media (min-width:560px){
    .kpi{grid-template-columns:repeat(4, 1fr)}
    .modal{align-items:center}
    .modal-content{border-radius:16px;max-height:90vh}
  }

  /* Estilo para o √≠cone de menu hamburguer */
  .hamburger {
    display: inline-block;
    width: 24px;
    height: 18px;
    position: relative;
  }
  .hamburger span {
    display: block;
    position: absolute;
    height: 2px;
    width: 100%;
    background: white;
    border-radius: 2px;
    opacity: 1;
    left: 0;
    transform: rotate(0deg);
    transition: .25s ease-in-out;
  }
  .hamburger span:nth-child(1) { top: 0px; }
  .hamburger span:nth-child(2) { top: 8px; }
  .hamburger span:nth-child(3) { top: 16px; }

  /* Loading dentro dos bot√µes */
  .button-loading {
    pointer-events: none;
    opacity: 0.7;
  }
  .button-loading::after {
    content: '';
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: buttonSpin 1s linear infinite;
    margin-left: 8px;
  }
  @keyframes buttonSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Badge para notifica√ß√µes */
  .badge {
    background: var(--rose);
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 0.7rem;
    margin-left: 5px;
  }
</style>
</head>
<body>
  <div id="loader"><div class="spinner"></div></div>

  <header>
    <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">
      <div class="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
    üíÖ Manicure Pro
  </header>

  <!-- Menu lateral -->
  <div class="side-menu" id="side-menu">
    <div class="menu-header">Navega√ß√£o</div>
    <button class="menu-item tab active" data-target="clientes">üë• Clientes</button>
    <button class="menu-item tab" data-target="servicos">üíÖ Servi√ßos</button>
    <button class="menu-item tab" data-target="relatorios">üìä Relat√≥rios</button>
    <div class="menu-header">A√ß√µes R√°pidas</div>
    <button class="menu-item" id="quick-service">‚ûï Novo Atendimento</button>
    <button class="menu-item" id="quick-client">üë§ Novo Cliente</button>
    <div class="menu-header">Dados & Backup</div>
    <button class="menu-item" id="export-data">üì§ Exportar Dados</button>
    <button class="menu-item" id="import-data">üì• Importar Dados</button>
    <button class="menu-item" id="backup-now">üíæ Backup Agora</button>
    <button class="menu-item" id="reset-data">üîÑ Limpar Dados</button>
    <div class="menu-header">Sobre</div>
    <button class="menu-item" id="app-info">‚ÑπÔ∏è Sobre o App</button>
  </div>
  <div class="overlay" id="overlay"></div>

  <nav>
    <button class="tab active" data-target="clientes">üë• Clientes</button>
    <button class="tab" data-target="servicos">üíÖ Servi√ßos</button>
    <button class="tab" data-target="relatorios">üìä Relat√≥rios</button>
  </nav>

  <main>
    <!-- CLIENTES -->
    <section id="clientes" class="active">
      <h2>Novo Cliente</h2>
      <form id="f-add-client" class="card">
        <div class="row">
          <input id="in-client-name" type="text" placeholder="Nome do cliente" required />
          <input id="in-client-phone" type="tel" placeholder="Telefone (opcional)" />
        </div>
        <div class="row"><button type="submit" id="btn-add-client"></button></div>
      </form>

      <div class="row">
        <input type="text" id="search-client" placeholder="üîç Buscar cliente..." />
      </div>

      <h2>Lista de Clientes <span class="badge" id="client-count">0</span></h2>
      <div id="client-list" class="list"><div class="empty">Nenhum cliente cadastrado.</div></div>
    </section>

    <!-- SERVI√áOS -->
    <section id="servicos">
      <h2>Cadastro de Servi√ßos</h2>
      <form id="f-add-service" class="card">
        <div class="row">
          <input id="in-service-name" type="text" placeholder="Nome do servi√ßo (ex: M√£o)" required />
          <input id="in-service-price" type="number" inputmode="decimal" placeholder="Pre√ßo (R$)" step="0.01" min="0" required />
        </div>
        <div class="row"><button type="submit" id="btn-add-service"></button></div>
      </form>

      <h2>Servi√ßos Cadastrados <span class="badge" id="service-count">0</span></h2>
      <div id="service-list" class="list"><div class="empty">Nenhum servi√ßo cadastrado.</div></div>
    </section>

    <!-- RELAT√ìRIOS -->
    <section id="relatorios">
      <h2>Resumo Financeiro</h2>
      <div class="kpi">
        <div class="tile"><h3>A Receber</h3><p id="kpi-pending">R$ 0,00</p></div>
        <div class="tile"><h3>Recebido</h3><p id="kpi-paid">R$ 0,00</p></div>
        <div class="tile"><h3>Cr√©ditos</h3><p id="kpi-credit">R$ 0,00</p></div>
        <div class="tile"><h3>Este M√™s</h3><p id="kpi-month">R$ 0,00</p></div>
      </div>

      <h2>Estat√≠sticas</h2>
      <div class="card">
        <div class="row">
          <div class="tile"><h3>Total Clientes</h3><p id="stat-clients">0</p></div>
          <div class="tile"><h3>Servi√ßos Hoje</h3><p id="stat-today">0</p></div>
        </div>
        <div class="row">
          <div class="tile"><h3>Servi√ßos M√™s</h3><p id="stat-month">0</p></div>
          <div class="tile"><h3>Faturamento</h3><p id="stat-revenue">R$ 0,00</p></div>
        </div>
      </div>
      
      <h2>Backup & Restaura√ß√£o</h2>
      <div class="card">
        <p style="margin-top: 0;">Fa√ßa backup dos seus dados para n√£o perd√™-los.</p>
        <div class="actions">
          <button id="btn-export" class="clean">üì§ Exportar Tudo</button>
          <button id="btn-import">üì• Importar</button>
          <button id="btn-print" class="clean">üñ®Ô∏è Imprimir Relat√≥rio</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL ATENDIMENTO -->
  <div id="modal-atendimento" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-head">
        <h3 id="modal-title">Atendimento</h3>
        <button class="modal-close" type="button" aria-label="Fechar">√ó</button>
      </div>
      <form id="f-service">
        <input type="hidden" id="modal-client-id" />
        <div class="card">
          <label style="color:#666">Cliente</label>
          <select id="select-client" required>
            <option value="">Selecione um cliente</option>
          </select>
        </div>
        <div class="card"><label style="color:#666">Data</label><input id="in-date" type="date" required /></div>
        <div class="card"><div style="color:#666;margin-bottom:6px">Servi√ßos</div><div id="opts"></div></div>
        <div class="card"><label style="color:#666">Adicionar cr√©dito (opcional)</label><input id="in-credit" type="number" inputmode="decimal" step="0.01" min="0" placeholder="Ex: 20,00" /></div>
        <div class="card"><label><input id="in-paid" type="checkbox" /> Marcar como pago</label></div>
        <div class="card">
          <div class="row" style="justify-content:space-between; padding: 0 8px;">
            <div>Total selecionado</div>
            <div><strong id="sum">R$ 0,00</strong></div>
          </div>
          <button type="submit" class="ok" id="btn-save-service"></button>
          <button type="button" class="clean" id="bt-cancel-atendimento">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL DI√ÅLOGO GEN√âRICO -->
  <div id="modal-dialogo" class="modal" aria-hidden="true">
      <div class="modal-content">
          <div class="modal-head">
              <h3 id="dialog-title"></h3>
              <button class="modal-close" type="button" aria-label="Fechar">√ó</button>
          </div>
          <p id="dialog-message" style="margin: 8px 0 16px; color: var(--muted);"></p>
          <div id="dialog-inputs"></div>
          <div id="dialog-buttons" class="row"></div>
      </div>
  </div>

  <!-- TOAST / NOTIFICA√á√ÉO -->
  <div id="toast" class="toast"></div>

<script>
(function(){
  "use strict";

  // ===== CONFIGURA√á√ÉO DO APP =====
  const APP_CONFIG = {
    name: "Manicure Pro",
    version: "2.0.0",
    storageKey: "manicure_app_data",
    backupInterval: 24 * 60 * 60 * 1000 // 24 horas
  };

  /* ===== √çcones SVG ===== */
  const ICONS = {
    add: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
    check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
    edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
    trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
    user: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`
  };

  /* ===== Utils essenciais ===== */
  const fmtBRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  const toBRL = v => fmtBRL.format(Number.isFinite(+v)? +v : 0);
  const todayISO = () => new Date().toISOString().split('T')[0];
  const uid = () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2));
  const $ = id => document.getElementById(id);
  const escapeHTML = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));

  // ===== SISTEMA DE BACKUP AUTOM√ÅTICO =====
  const BackupSystem = {
    lastBackup: localStorage.getItem('last_backup') || 0,
    
    checkAutoBackup() {
      const now = Date.now();
      if (now - this.lastBackup > APP_CONFIG.backupInterval) {
        this.createBackup();
        this.lastBackup = now;
        localStorage.setItem('last_backup', now);
      }
    },
    
    createBackup() {
      const data = {
        clients: storage.get('clients', []),
        services: storage.get('services', []),
        timestamp: new Date().toISOString(),
        version: APP_CONFIG.version
      };
      
      try {
        localStorage.setItem('auto_backup', JSON.stringify(data));
        console.log('Backup autom√°tico criado');
      } catch (e) {
        console.error('Erro no backup autom√°tico:', e);
      }
    },
    
    restoreBackup() {
      try {
        const backup = localStorage.getItem('auto_backup');
        if (backup) {
          const data = JSON.parse(backup);
          storage.set('clients', data.clients || []);
          storage.set('services', data.services || []);
          return true;
        }
      } catch (e) {
        console.error('Erro ao restaurar backup:', e);
      }
      return false;
    }
  };

  /* ===== Storage com debounce (menos I/O) ===== */
  let saveTimer=null;
  const storage = {
    get(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(fallback));
      } catch (e) {
        console.error(`Erro ao ler dados para a chave "${key}", usando dados padr√£o.`, e);
        return JSON.parse(JSON.stringify(fallback));
      }
    },
    set(key, val){
      try{
        const data = JSON.stringify(val);
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          localStorage.setItem(key, data);
          saveTimer = null;
          // Atualiza estat√≠sticas
          updateStats();
        }, 300);
        return true;
      }catch(e){ showToast('N√£o foi poss√≠vel salvar os dados.'); return false; }
    }
  };

  /* ===== UI: Toast & Dialog ===== */
  let toastTimer = null;
  function showToast(message, type = 'info') {
    const el = $('toast');
    el.textContent = message;
    el.className = 'toast'; // Reset classes
    if (type === 'error') el.style.background = 'rgba(198, 40, 40, 0.9)';
    else if (type === 'success') el.style.background = 'rgba(46, 125, 50, 0.9)';
    
    el.classList.add('show');
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
  }

  function showDialog(opts) {
    return new Promise(resolve => {
        const modal = $('modal-dialogo');
        $('dialog-title').textContent = opts.title || '';
        $('dialog-message').textContent = opts.message || '';

        const inputsWrap = $('dialog-inputs');
        inputsWrap.innerHTML = (opts.inputs || []).map(i => `
            <label style="color:#666; font-size: 0.9rem">${escapeHTML(i.label)}</label>
            <input type="${i.type || 'text'}" id="dialog-input-${i.id}" placeholder="${escapeHTML(i.placeholder || '')}" value="${escapeHTML(i.value || '')}" ${i.required ? 'required' : ''} />
        `).join('');

        const buttonsWrap = $('dialog-buttons');
        buttonsWrap.innerHTML = (opts.buttons || []).map(b => `
            <button class="${b.class || ''}" data-value="${escapeHTML(b.value)}" ${b.disabled ? 'disabled' : ''}>${b.icon ? b.icon : ''} ${escapeHTML(b.label)}</button>
        `).join('');

        const onAction = (value) => {
            modal.classList.remove('show');
            buttonsWrap.removeEventListener('click', clickHandler);
            closeBtn.removeEventListener('click', closeHandler);
            modal.removeEventListener('click', modalClickHandler);
            const results = (opts.inputs || []).reduce((acc, i) => {
                acc[i.id] = $(`dialog-input-${i.id}`).value;
                return acc;
            }, {});
            resolve({ value, inputs: results });
        };

        const clickHandler = e => { 
            e.stopPropagation(); 
            const btn = e.target.closest('button'); 
            if (btn && !btn.disabled) onAction(btn.dataset.value); 
        };
        const closeBtn = modal.querySelector('.modal-close');
        const closeHandler = () => onAction(null);
        const modalClickHandler = e => { if (e.target === modal) onAction(null); };

        buttonsWrap.addEventListener('click', clickHandler);
        closeBtn.addEventListener('click', closeHandler);
        modal.addEventListener('click', modalClickHandler);
        modal.classList.add('show');
        
        // Foca no primeiro input se existir
        const firstInput = inputsWrap.querySelector('input');
        if (firstInput) firstInput.focus();
    });
  }

  // ===== FUN√á√ïES DE EXPORTA√á√ÉO/IMPORTA√á√ÉO =====
  function exportData() {
    const data = {
      clients: storage.get('clients', []),
      services: storage.get('services', []),
      exportDate: new Date().toISOString(),
      app: APP_CONFIG.name,
      version: APP_CONFIG.version
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-manicure-${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Dados exportados com sucesso!', 'success');
  }

  function importData(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Valida√ß√£o b√°sica dos dados
          if (!data.clients || !data.services) {
            throw new Error('Formato de arquivo inv√°lido');
          }
          
          // Backup antes da importa√ß√£o
          const backup = {
            clients: storage.get('clients', []),
            services: storage.get('services', []),
            timestamp: new Date().toISOString()
          };
          localStorage.setItem('pre_import_backup', JSON.stringify(backup));
          
          // Aplica os dados
          storage.set('clients', data.clients);
          storage.set('services', data.services);
          
          showToast('Dados importados com sucesso!', 'success');
          resolve(data);
        } catch (error) {
          showToast('Erro ao importar arquivo: ' + error.message, 'error');
          reject(error);
        }
      };
      reader.readAsText(file);
    });
  }

  // ===== SISTEMA DE RELAT√ìRIOS =====
  function generateReport() {
    const now = new Date();
    const month = now.getMonth();
    const year = now.getFullYear();
    
    let report = `RELAT√ìRIO MANICURE PRO\n`;
    report += `Data: ${now.toLocaleDateString('pt-BR')}\n`;
    report += `====================\n\n`;
    
    // Resumo financeiro
    let pend = 0, paid = 0, credit = 0, monthRevenue = 0;
    let todayServices = 0, monthServices = 0;
    
    clients.forEach(client => {
      credit += client.credit || 0;
      client.services.forEach(service => {
        const val = service.totalValue || 0;
        if (service.paid) paid += val; else pend += val;
        
        const serviceDate = new Date(service.date);
        if (serviceDate.toDateString() === now.toDateString()) todayServices++;
        if (serviceDate.getMonth() === month && serviceDate.getFullYear() === year) {
          monthServices++;
          if (service.paid) monthRevenue += val;
        }
      });
    });
    
    report += `RESUMO FINANCEIRO:\n`;
    report += `A Receber: ${toBRL(pend)}\n`;
    report += `Recebido: ${toBRL(paid)}\n`;
    report += `Cr√©ditos: ${toBRL(credit)}\n`;
    report += `Este M√™s: ${toBRL(monthRevenue)}\n\n`;
    
    report += `ESTAT√çSTICAS:\n`;
    report += `Total Clientes: ${clients.length}\n`;
    report += `Servi√ßos Hoje: ${todayServices}\n`;
    report += `Servi√ßos Este M√™s: ${monthServices}\n\n`;
    
    // Clientes com pend√™ncias
    const clientsWithDebt = clients.filter(c => 
      c.services.some(s => !s.paid) || (c.credit || 0) > 0
    );
    
    if (clientsWithDebt.length > 0) {
      report += `CLIENTES COM PEND√äNCIAS:\n`;
      clientsWithDebt.forEach(client => {
        const debt = client.services.reduce((acc, s) => acc + (!s.paid ? s.totalValue : 0), 0);
        report += `- ${client.name}: ${toBRL(debt)} ${client.credit ? `(Cr√©dito: ${toBRL(client.credit)})` : ''}\n`;
      });
    }
    
    return report;
  }

  function printReport() {
    const report = generateReport();
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head>
          <title>Relat√≥rio Manicure</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { color: #d81b60; }
            pre { white-space: pre-wrap; }
          </style>
        </head>
        <body>
          <h1>Relat√≥rio Manicure Pro</h1>
          <pre>${report}</pre>
          <script>
            window.onload = function() { window.print(); }
          <\/script>
        </body>
      </html>
    `);
    printWindow.document.close();
  }

  // ===== ATUALIZA√á√ÉO DE ESTAT√çSTICAS =====
  function updateStats() {
    // Atualiza contadores
    $('client-count').textContent = clients.length;
    $('service-count').textContent = services.length;
    
    // Atualiza estat√≠sticas
    const now = new Date();
    const month = now.getMonth();
    const year = now.getFullYear();
    
    let todayServices = 0, monthServices = 0, totalRevenue = 0;
    
    clients.forEach(client => {
      client.services.forEach(service => {
        const serviceDate = new Date(service.date);
        if (serviceDate.toDateString() === now.toDateString()) todayServices++;
        if (serviceDate.getMonth() === month && serviceDate.getFullYear() === year) {
          monthServices++;
          if (service.paid) totalRevenue += service.totalValue || 0;
        }
      });
    });
    
    $('stat-clients').textContent = clients.length;
    $('stat-today').textContent = todayServices;
    $('stat-month').textContent = monthServices;
    $('stat-revenue').textContent = toBRL(totalRevenue);
  }

  /* ===== Estado + migra√ß√£o m√≠nima ===== */
  const DEFAULT_SERVICES = [
    { id: uid(), name:'M√£o', price:25 },
    { id: uid(), name:'P√©',  price:30 },
    { id: uid(), name:'Esmalta√ß√£o', price:10 },
    { id: uid(), name:'M√£o e P√©', price:50 },
    { id: uid(), name:'Manuten√ß√£o', price:20 }
  ];
  let clients = [];
  let services = [];

  function migrate(){
    try {
      let loadedServices = storage.get('services', DEFAULT_SERVICES);
      services = (Array.isArray(loadedServices)? loadedServices:[]).map(s=>({
        id: s.id || uid(), name: String(s.name||'').trim(), price: Number.isFinite(+s.price)? +s.price : 0
      })).filter(s=>s.name);

      let loadedClients = storage.get('clients', []);
      clients = (Array.isArray(loadedClients)? loadedClients:[]).map(c=>{
        const svcArr = Array.isArray(c.services)? c.services : [];
        return {
          id: c.id || uid(), 
          name: String(c.name||'').trim() || 'Sem nome', 
          phone: c.phone || '',
          credit: Number.isFinite(+c.credit)? +c.credit : 0,
          services: svcArr.map(s=>{
            const items = Array.isArray(s.services_provided)? s.services_provided.map(it=>{
              const name = (it && it.name) ? String(it.name).trim() : '';
              const price = (it && Number.isFinite(+it.price)) ? +it.price : 0;
              return { name: name, price: price };
            }).filter(it=>it.name):[];
            const total = Number.isFinite(+s.totalValue)? +s.totalValue : items.reduce((a,b)=>a+(+b.price||0),0);
            return { 
              date: s.date || todayISO(), 
              services_provided: items, 
              totalValue: total, 
              paid: !!s.paid 
            };
          })
        };
      });
      storage.set('services', services); 
      storage.set('clients', clients);
      
      // Verifica backup autom√°tico
      BackupSystem.checkAutoBackup();
      
    } catch(e) {
      console.error("Falha cr√≠tica na migra√ß√£o de dados. Usando dados padr√£o.", e);
      // Tenta restaurar do backup autom√°tico
      if (BackupSystem.restoreBackup()) {
        showToast("Dados restaurados do backup autom√°tico.", "success");
        migrate(); // Recarrega os dados restaurados
      } else {
        clients = [];
        services = DEFAULT_SERVICES;
        showToast("Erro ao carregar dados. Iniciando com dados padr√£o.", "error");
      }
    }
  }
  
  /* ===== Render Functions ===== */
  function renderClients(){
    const wrap = $('client-list');
    const searchTerm = ($('search-client')?.value || '').toLowerCase();
    
    let filteredClients = clients;
    if (searchTerm) {
      filteredClients = clients.filter(c => 
        c.name.toLowerCase().includes(searchTerm) ||
        (c.phone && c.phone.includes(searchTerm))
      );
    }
    
    if(!filteredClients.length){ 
      wrap.innerHTML = `<div class="empty">${searchTerm ? 'Nenhum cliente encontrado' : 'Nenhum cliente cadastrado'}</div>`; 
      return; 
    }
    
    wrap.innerHTML = filteredClients.sort((a,b) => a.name.localeCompare(b.name)).map(c=>{
      const pend = (c.services||[]).reduce((acc,s)=> acc + (!s.paid ? (+s.totalValue||0) : 0), 0);
      const lastService = c.services.length > 0 ? 
        new Date(c.services[c.services.length-1].date).toLocaleDateString('pt-BR') : 'Nunca';
      
      return `
        <div class="card client">
          <div class="name" style="display:flex; align-items:center; gap:8px;">
            ${ICONS.user} ${escapeHTML(c.name)}
            ${c.phone ? `<span style="margin-left:auto; font-size:0.8rem; color:var(--muted)">üìû ${escapeHTML(c.phone)}</span>` : ''}
          </div>
          <div class="meta">A receber: <strong>${toBRL(pend)}</strong></div>
          <div class="meta">Cr√©dito: <strong>${toBRL(c.credit||0)}</strong></div>
          <div class="meta">√öltimo atendimento: <strong>${lastService}</strong></div>
          <div class="actions">
            <button data-action="attend" data-id="${c.id}">${ICONS.add} Atendimento</button>
            <button class="ok" data-action="confirm" data-id="${c.id}" ${pend <= 0 ? 'disabled' : ''}>${ICONS.check} Quitar Saldo</button>
            <button class="clean" data-action="rename" data-id="${c.id}">${ICONS.edit} Editar</button>
            <button class="danger" data-action="delete" data-id="${c.id}">${ICONS.trash} Excluir</button>
          </div>
        </div>`;
    }).join('');
  }

  function renderServices(){
    const wrap = $('service-list');
    if(!services.length){ wrap.innerHTML = `<div class="empty">Nenhum servi√ßo cadastrado.</div>`; return; }
    wrap.innerHTML = services.sort((a,b) => a.name.localeCompare(b.name)).map((s,i)=>`
      <div class="card service-item">
        <div class="info">
          <strong>${escapeHTML(s.name)}</strong>
          <div style="color:#666">${toBRL(s.price)}</div>
        </div>
        <div class="actions">
          <button class="clean" data-action="edit-service" data-id="${s.id}">${ICONS.edit} Editar</button>
          <button class="danger" data-action="del-service" data-id="${s.id}">${ICONS.trash} Excluir</button>
        </div>
      </div>`).join('');
  }

  function renderReports(){
    let pend=0, paid=0, credit=0, month=0;
    const now = new Date(), m = now.getMonth(), y = now.getFullYear();
    for(const c of clients){
      credit += +c.credit||0;
      for(const s of (c.services||[])){
        const val = +s.totalValue||0;
        if(s.paid) paid += val; else pend += val;
        try {
          if(s.date && typeof s.date === 'string' && s.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const d = new Date(s.date);
            if(s.paid && d.getMonth()===m && d.getFullYear()===y) month += val;
          }
        } catch(e) { console.warn("Data de servi√ßo inv√°lida:", s.date) }
      }
    }
    $('kpi-pending').textContent = toBRL(pend);
    $('kpi-paid').textContent   = toBRL(paid);
    $('kpi-credit').textContent  = toBRL(credit);
    $('kpi-month').textContent   = toBRL(month);
    
    updateStats();
  }

  // ===== SISTEMA DE BUSCA =====
  function initSearch() {
    const searchInput = $('search-client');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          renderClients();
        }, 300);
      });
    }
  }

  /* ===== Modal Atendimento ===== */
  const modalAtendimento = $('modal-atendimento'), optsWrap = $('opts'), sumEl = $('sum');
  
  function updateClientSelect() {
    const select = $('select-client');
    select.innerHTML = '<option value="">Selecione um cliente</option>';
    clients.sort((a,b) => a.name.localeCompare(b.name)).forEach(client => {
      const option = document.createElement('option');
      option.value = client.id;
      option.textContent = client.name;
      select.appendChild(option);
    });
  }
  
  function openModalAtendimento(client = null){
    if(!services.length){ 
      showToast('Cadastre ao menos um servi√ßo antes.', 'error'); 
      switchTab('servicos'); 
      return; 
    }
    
    updateClientSelect();
    
    if (client) {
      $('select-client').value = client.id;
      $('select-client').disabled = true;
    } else {
      $('select-client').disabled = false;
    }
    
    $('modal-title').textContent = client ? `Atendimento ‚Ä¢ ${client.name}` : 'Novo Atendimento';
    $('modal-client-id').value = client ? client.id : '';
    $('in-date').value = todayISO();
    $('in-credit').value = ''; 
    $('in-paid').checked = false; 
    sumEl.textContent = toBRL(0);
    
    optsWrap.innerHTML = services.map(s=>`
      <label class="opt">
        <input type="checkbox" data-price="${s.price}" data-name="${escapeHTML(s.name)}" />
        <span>${escapeHTML(s.name)} ‚Äî <span style="color:#666">${toBRL(s.price)}</span></span>
      </label>`).join('');
      
    modalAtendimento.classList.add('show'); 
    modalAtendimento.setAttribute('aria-hidden','false');
  }
  
  function closeModalAtendimento(){ 
    modalAtendimento.classList.remove('show'); 
    modalAtendimento.setAttribute('aria-hidden','true'); 
  }
  
  // Event listeners do modal
  $('bt-cancel-atendimento').addEventListener('click', closeModalAtendimento);
  modalAtendimento.querySelector('.modal-close').addEventListener('click', closeModalAtendimento);
  modalAtendimento.addEventListener('click', e=>{ if(e.target===modalAtendimento) closeModalAtendimento(); });
  optsWrap.addEventListener('change', ()=>{
    const total = [...optsWrap.querySelectorAll('input:checked')].reduce((a,el)=>a+(+el.dataset.price||0),0);
    sumEl.textContent = toBRL(total);
  });

  /* ===== Navega√ß√£o ===== */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=> switchTab(btn.dataset.target));
  });
  
  function switchTab(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.target===id));
    document.querySelectorAll('section').forEach(s=>s.classList.toggle('active', s.id===id));
    
    // Fecha o menu lateral se estiver aberto
    closeSideMenu();
    
    if(id==='servicos') renderServices();
    if(id==='relatorios') renderReports();
    if(id==='clientes') renderClients();
  }

  // ===== MENU LATERAL =====
  function initSideMenu() {
    const menuToggle = $('menu-toggle');
    const sideMenu = $('side-menu');
    const overlay = $('overlay');
    
    function openSideMenu() {
      sideMenu.classList.add('open');
      overlay.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSideMenu() {
      sideMenu.classList.remove('open');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    }
    
    menuToggle.addEventListener('click', openSideMenu);
    overlay.addEventListener('click', closeSideMenu);
    
    // Fecha menu ao clicar em um item
    sideMenu.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', closeSideMenu);
    });
    
    return { openSideMenu, closeSideMenu };
  }

  const { closeSideMenu } = initSideMenu();

  /* ===== Eventos: Clientes ===== */
  $('f-add-client').addEventListener('submit', e=>{
    e.preventDefault();
    const nameInput = $('in-client-name');
    const phoneInput = $('in-client-phone');
    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();
    
    if(!name){ showToast('Informe o nome do cliente.', 'error'); return; }
    
    // Verifica se cliente j√° existe
    if(clients.some(c => c.name.toLowerCase() === name.toLowerCase())){
      showToast('J√° existe um cliente com este nome.', 'error');
      return;
    }
    
    clients.push({ id:uid(), name, phone, credit:0, services:[] });
    storage.set('clients', clients);
    nameInput.value = '';
    phoneInput.value = '';
    nameInput.focus();
    renderClients();
    showToast('Cliente adicionado com sucesso!', 'success');
  });

  $('client-list').addEventListener('click', async e=>{
    const btn = e.target.closest('button'); 
    if(!btn || btn.disabled) return;
    
    const id = btn.dataset.id; 
    const act = btn.dataset.action;
    const client = clients.find(c=> String(c.id)===String(id)); 
    if(!client) return;

    if(act==='attend'){ openModalAtendimento(client); return; }
    
    if(act==='confirm'){
      const unpaidServices = (client.services||[]).filter(s => !s.paid);
      const pend = unpaidServices.reduce((acc, s) => acc + (s.totalValue || 0), 0);
      if (pend <= 0) { showToast('Sem atendimentos em aberto.', 'info'); return; }
      
      const creditUsed = Math.min(pend, client.credit || 0);
      if (creditUsed > 0) { client.credit -= creditUsed; }
      for(const s of unpaidServices){ s.paid = true; }
      
      storage.set('clients', clients);
      renderClients();
      let toastMessage = 'Saldo quitado com sucesso!';
      if (creditUsed > 0) { 
        toastMessage = `Saldo quitado! ${toBRL(creditUsed)} de cr√©dito foram utilizados.`; 
      }
      showToast(toastMessage, 'success');
      return;
    }
    
    if(act==='rename'){
      const res = await showDialog({
        title: 'Renomear Cliente',
        inputs: [
          { id: 'name', label: 'Novo nome', value: client.name, required: true },
          { id: 'phone', label: 'Telefone', value: client.phone || '' }
        ],
        buttons: [
          { label: 'Cancelar', value: 'cancel' }, 
          { label: 'Salvar', value: 'ok', class: 'ok', icon: ICONS.check }
        ]
      });
      
      if(res.value==='ok' && res.inputs.name.trim()){
        client.name = res.inputs.name.trim(); 
        client.phone = res.inputs.phone.trim();
        storage.set('clients', clients); 
        renderClients(); 
        showToast('Cliente atualizado!', 'success');
      }
      return;
    }
    
    if(act==='delete'){
      const res = await showDialog({
        title: 'Excluir Cliente',
        message: `Tem certeza que deseja excluir "${client.name}" e todos os seus registros? Esta a√ß√£o n√£o pode ser desfeita.`,
        buttons: [
          { label: 'Cancelar', value: 'cancel' }, 
          { label: 'Excluir', value: 'ok', class: 'danger', icon: ICONS.trash }
        ]
      });
      
      if(res.value==='ok'){
        clients = clients.filter(c=> String(c.id)!==String(client.id));
        storage.set('clients', clients); 
        renderClients(); 
        showToast('Cliente exclu√≠do.', 'success');
      }
      return;
    }
  });

  /* ===== Eventos: Atendimentos (form do modal) ===== */
  $('f-service').addEventListener('submit', e=>{
    e.preventDefault();
    const clientId = $('modal-client-id').value || $('select-client').value;
    const client = clients.find(c=> String(c.id)===String(clientId)); 
    
    if(!client){ 
      showToast('Selecione um cliente v√°lido.', 'error'); 
      return; 
    }
    
    const date = $('in-date').value || todayISO();
    const credit = +($('in-credit').value||0);
    const paid = $('in-paid').checked;
    const selected = [...optsWrap.querySelectorAll('input:checked')].map(el=>({ 
      name: el.dataset.name, 
      price:+el.dataset.price||0 
    }));
    const total = selected.reduce((a,b)=>a+(+b.price||0),0);

    if(selected.length===0 && !(credit>0)){ 
      showToast('Selecione ao menos um servi√ßo ou informe um cr√©dito.', 'error'); 
      return; 
    }
    
    if(credit>0) client.credit = (+client.credit||0) + credit;
    if(selected.length>0) {
      client.services.push({ 
        date, 
        services_provided:selected, 
        totalValue:total, 
        paid 
      });
    }

    storage.set('clients', clients);
    renderClients();
    closeModalAtendimento();
    showToast('Atendimento salvo!', 'success');
  });

  /* ===== Eventos: Servi√ßos ===== */
  $('f-add-service').addEventListener('submit', e=>{
    e.preventDefault();
    const nameInput = $('in-service-name');
    const priceInput = $('in-service-price');
    const name = nameInput.value.trim();
    const price = +(priceInput.value||0);
    
    if(!name){ showToast('Nome do servi√ßo √© obrigat√≥rio.', 'error'); return; }
    if(!(price>=0)){ showToast('Pre√ßo inv√°lido.', 'error'); return; }

    const existingService = services.find(s=> s.name.toLowerCase()===name.toLowerCase());
    if(existingService){ 
      existingService.price = price; 
      showToast('Servi√ßo atualizado com sucesso!', 'success');
    } else{ 
      services.push({ id:uid(), name, price }); 
      showToast('Servi√ßo adicionado com sucesso!', 'success');
    }

    storage.set('services', services);
    nameInput.value=''; 
    priceInput.value='';
    nameInput.focus();
    renderServices();
  });

  $('service-list').addEventListener('click', async e=>{
    const btn = e.target.closest('button'); 
    if(!btn) return;
    
    const id = btn.dataset.id; 
    const act = btn.dataset.action;
    const service = services.find(s => s.id === id);
    if(!service) return;

    if(act==='edit-service'){
      const res = await showDialog({
        title: 'Editar Servi√ßo',
        inputs: [
            { id: 'name', label: 'Nome do servi√ßo', value: service.name, required: true },
            { id: 'price', label: 'Pre√ßo (R$)', type: 'number', value: String(service.price), required: true }
        ],
        buttons: [
          { label: 'Cancelar', value: 'cancel' }, 
          { label: 'Salvar', value: 'ok', class: 'ok', icon: ICONS.check }
        ]
      });

      const newName = res.inputs.name.trim();
      const newPrice = +(res.inputs.price || '0');
      
      if (res.value === 'ok' && newName && newPrice >= 0) {
        service.name = newName;
        service.price = newPrice;
        storage.set('services', services); 
        renderServices(); 
        showToast('Servi√ßo atualizado!', 'success');
      } else if (res.value === 'ok') {
        showToast('Dados inv√°lidos.', 'error');
      }
      return;
    }
    
    if(act==='del-service'){
      const res = await showDialog({
        title: 'Excluir Servi√ßo',
        message: `Tem certeza que deseja excluir o servi√ßo "${service.name}"?`,
        buttons: [
          { label: 'Cancelar', value: 'cancel' }, 
          { label: 'Excluir', value: 'ok', class: 'danger', icon: ICONS.trash }
        ]
      });
      
      if(res.value==='ok'){
        services = services.filter(s => s.id !== id);
        storage.set('services', services); 
        renderServices(); 
        showToast('Servi√ßo exclu√≠do.', 'success');
      }
      return;
    }
  });

  // ===== EVENTOS DO MENU LATERAL =====
  document.getElementById('quick-service').addEventListener('click', () => {
    openModalAtendimento();
  });

  document.getElementById('quick-client').addEventListener('click', () => {
    switchTab('clientes');
    $('in-client-name').focus();
  });

  document.getElementById('export-data').addEventListener('click', exportData);

  document.getElementById('import-data').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (file) importData(file).then(() => {
        migrate(); // Recarrega os dados
        renderClients();
        renderServices();
        renderReports();
      });
    };
    input.click();
  });

  document.getElementById('backup-now').addEventListener('click', () => {
    BackupSystem.createBackup();
    showToast('Backup criado com sucesso!', 'success');
  });

  document.getElementById('reset-data').addEventListener('click', async () => {
    const res = await showDialog({
      title: 'Limpar Todos os Dados',
      message: '‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° apagar TODOS os clientes e servi√ßos. Tem certeza?',
      buttons: [
        { label: 'Cancelar', value: 'cancel' },
        { label: 'Limpar Tudo', value: 'ok', class: 'danger' }
      ]
    });
    
    if (res.value === 'ok') {
      localStorage.clear();
      showToast('Dados limpos. Recarregando...', 'success');
      setTimeout(() => location.reload(), 1500);
    }
  });

  document.getElementById('app-info').addEventListener('click', () => {
    showDialog({
      title: 'Sobre o App',
      message: `${APP_CONFIG.name} v${APP_CONFIG.version}\n\nUm aplicativo simples e eficiente para gerenciar sua clientela de manicure.\n\nRecursos:\n‚Ä¢ Cadastro de clientes e servi√ßos\n‚Ä¢ Controle financeiro\n‚Ä¢ Backup autom√°tico\n‚Ä¢ Relat√≥rios detalhados`,
      buttons: [{ label: 'Fechar', value: 'close', class: 'ok' }]
    });
  });

  // ===== EVENTOS DE EXPORTA√á√ÉO/IMPORTA√á√ÉO =====
  $('btn-export').addEventListener('click', exportData);

  $('btn-import').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (file) importData(file).then(() => {
        migrate();
        renderClients();
        renderServices();
        renderReports();
      });
    };
    input.click();
  });

  $('btn-print').addEventListener('click', printReport);

  // ===== SERVICE WORKER PARA PWA =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/sw.js').then(function(registration) {
        console.log('ServiceWorker registration successful');
      }, function(err) {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }

  // ===== PREVEN√á√ÉO DE SA√çDA ACIDENTAL =====
  window.addEventListener('beforeunload', function (e) {
    // Apenas um aviso simples para evitar sa√≠da acidental
    if (clients.length > 0) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  /* ===== Boot ===== */
  function init() {
    // Injeta os √≠cones nos bot√µes est√°ticos
    $('btn-add-client').innerHTML = `${ICONS.add} Adicionar Cliente`;
    $('btn-add-service').innerHTML = `${ICONS.add} Adicionar ou Atualizar`;
    $('btn-save-service').innerHTML = `${ICONS.check} Salvar atendimento`;
    
    migrate();
    renderClients();
    initSearch();

    // Esconde a tela de carregamento
    const loader = $('loader');
    loader.style.opacity = '0';
    setTimeout(() => loader.style.display = 'none', 300);

    // Mostra mensagem de boas-vindas
    setTimeout(() => {
      if (clients.length === 0 && services.length === DEFAULT_SERVICES.length) {
        showToast('Bem-vindo ao Manicure Pro! Comece cadastrando seus clientes.', 'success');
      }
    }, 1000);
  }

  // Inicia o aplicativo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
</body>
</html>
